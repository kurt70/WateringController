@page "/"
@implements IAsyncDisposable
@inject WateringHubClient HubClient
@inject HttpClient Http

<PageTitle>Status</PageTitle>

<h1>Status</h1>

<div class="row g-3">
    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Connections</h5>
            <table class="table table-sm mb-0 align-middle">
                <tbody>
                    <tr>
                        <td class="text-start">SignalR</td>
                        @{
                            var signalrStatus = HubClient.IsConnected ? "connected" : "disconnected";
                        }
                        <td class="text-center">
                            <span class="status-icon @GetStatusClass(signalrStatus)" aria-hidden="true"></span>
                        </td>
                        <td class="text-start @GetStatusClass(signalrStatus)">@signalrStatus</td>
                        <td class="text-end text-muted">@GetLastSeenText(_lastSignalrChange)</td>
                    </tr>
                    <tr>
                        <td class="text-start">MQTT Broker</td>
                        @{
                            var mqttStatus = GetMqttStatusText();
                        }
                        <td class="text-center">
                            <span class="status-icon @GetStatusClass(mqttStatus)" aria-hidden="true"></span>
                        </td>
                        <td class="text-start @GetStatusClass(mqttStatus)">@mqttStatus</td>
                        <td class="text-end text-muted">@GetLastSeenText(_health?.Mqtt?.LastConnectedAt)</td>
                    </tr>
                    <tr>
                        <td class="text-start">Pump Controller</td>
                        @{
                            var pumpStatus = GetDeviceStatusText(_pumpState?.ReceivedAt);
                        }
                        <td class="text-center">
                            <span class="status-icon @GetStatusClass(pumpStatus)" aria-hidden="true"></span>
                        </td>
                        <td class="text-start @GetStatusClass(pumpStatus)">@pumpStatus</td>
                        <td class="text-end text-muted">@GetLastSeenText(_pumpState?.ReceivedAt)</td>
                    </tr>
                    <tr>
                        <td class="text-start">Water Level Controller</td>
                        @{
                            var waterStatus = GetDeviceStatusText(_latest?.ReceivedAt);
                        }
                        <td class="text-center">
                            <span class="status-icon @GetStatusClass(waterStatus)" aria-hidden="true"></span>
                        </td>
                        <td class="text-start @GetStatusClass(waterStatus)">@waterStatus</td>
                        <td class="text-end text-muted">@GetLastSeenText(_latest?.ReceivedAt)</td>
                    </tr>
                </tbody>
            </table>
            <div class="text-muted small mt-2">
                Device status uses latest received MQTT message timestamps.
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Water Level</h5>
            @if (_latest is null)
            {
                <p>No water level updates yet.</p>
            }
            else
            {
                <div class="water-level">
                    <div class="water-tank">
                        <div class="water-fill" style="height:@_latest.LevelPercent%"></div>
                        <div class="water-label">@_latest.LevelPercent%</div>
                    </div>
                    <div class="water-meta">
                        <div><strong>Sensors:</strong> @string.Join(", ", _latest.Sensors.Select(value => value ? "1" : "0"))</div>
                        <div><strong>Measured:</strong> @_latest.MeasuredAt.ToString("u")</div>
                        <div><strong>Reported:</strong> @_latest.ReportedAt.ToString("u")</div>
                        <div><strong>Received:</strong> @_latest.ReceivedAt.ToString("u")</div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Pump State</h5>
            @if (_pumpState is null)
            {
                <p>No pump state updates yet.</p>
            }
            else
            {
                <div><strong>Running:</strong> @(_pumpState.Running ? "yes" : "no")</div>
                <div><strong>Since:</strong> @_pumpState.Since?.ToString("u")</div>
                <div><strong>Last run seconds:</strong> @_pumpState.LastRunSeconds</div>
                <div><strong>Last request id:</strong> @_pumpState.LastRequestId</div>
                <div><strong>Reported:</strong> @_pumpState.ReportedAt.ToString("u")</div>
                <div><strong>Received:</strong> @_pumpState.ReceivedAt.ToString("u")</div>
            }
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Alarms</h5>
            @if (_alarms.Count == 0)
            {
                <p>No alarms.</p>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var alarm in _alarms)
                    {
                        <li class="list-group-item">
                            <strong>@alarm.Type</strong> (@alarm.Severity) - @alarm.Message
                            <div class="text-muted small">
                                @alarm.RaisedAt.ToString("u") (@GetLastSeenText(alarm.RaisedAt))
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Scheduling</h5>
            @if (_nextScheduleAt is null)
            {
                <div class="text-muted">No upcoming schedules.</div>
            }
            else
            {
                <div><strong>Next:</strong> @_nextScheduleAt.Value.ToLocalTime().ToString("ddd yyyy-MM-dd HH:mm:ss") (@GetLastSeenText(_nextScheduleAt))</div>
                <div><strong>Duration:</strong> @_nextSchedule?.RunSeconds s</div>
            }

            @if (_recentRuns.Count == 0)
            {
                <p class="mt-3">No scheduled runs yet.</p>
            }
            else
            {
                <div class="mt-3"><strong>Recent runs</strong></div>
                <ul class="list-group">
                    @foreach (var run in _recentRuns.Take(3))
                    {
                        <li class="list-group-item">
                            <div><strong>@run.RequestedAtUtc.ToLocalTime().ToString("u")</strong> (@GetLastSeenText(run.RequestedAtUtc))</div>
                            <div class="text-muted small">
                                @run.RunSeconds s, allowed: @(run.Allowed ? "yes" : "no"), reason: @run.Reason
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

@code {
    private WaterLevelUpdate? _latest;
    private PumpStateUpdate? _pumpState;
    private List<RunHistoryEntry> _recentRuns = new();
    private Schedule? _nextSchedule;
    private DateTimeOffset? _nextScheduleAt;
    private List<SystemAlarmUpdate> _alarms = new();
    private HealthStatus? _health;
    private CancellationTokenSource? _pollingCts;
    private DateTimeOffset? _lastSignalrChange;
    private static readonly TimeSpan DeviceStaleThreshold = TimeSpan.FromMinutes(2);

    protected override async Task OnInitializedAsync()
    {
        HubClient.WaterLevelUpdated += HandleWaterLevelUpdated;
        HubClient.PumpStateUpdated += HandlePumpStateUpdated;
        HubClient.AlarmRaised += HandleAlarmRaised;
        HubClient.ConnectionStateChanged += HandleConnectionStateChanged;
        _lastSignalrChange = DateTimeOffset.UtcNow;
        try
        {
            await HubClient.StartAsync();
        }
        catch
        {
            // Ignore SignalR startup failures; initial data loads via HTTP.
        }

        await LoadInitialStateAsync();
        StartPolling();
    }

    private void HandleConnectionStateChanged(bool isConnected)
    {
        _lastSignalrChange = DateTimeOffset.UtcNow;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleWaterLevelUpdated(WaterLevelUpdate update)
    {
        _latest = update;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandlePumpStateUpdated(PumpStateUpdate update)
    {
        _pumpState = update;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleAlarmRaised(SystemAlarmUpdate update)
    {
        if (!ContainsAlarm(update))
        {
            _alarms.Insert(0, update);
            if (_alarms.Count > 5)
            {
                _alarms.RemoveRange(5, _alarms.Count - 5);
            }
        }
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task LoadInitialStateAsync()
    {
        try
        {
            var healthResponse = await Http.GetAsync("/health");
            if (healthResponse.IsSuccessStatusCode)
            {
                _health = await healthResponse.Content.ReadFromJsonAsync<HealthStatus>();
            }
        }
        catch
        {
            // Ignore health load errors in UI.
        }

        try
        {
            var waterResponse = await Http.GetAsync("/api/waterlevel/latest");
            if (waterResponse.IsSuccessStatusCode)
            {
                _latest = await waterResponse.Content.ReadFromJsonAsync<WaterLevelUpdate>();
            }
        }
        catch
        {
            // Ignore water level load errors in UI.
        }

        try
        {
            var pumpResponse = await Http.GetAsync("/api/pump/latest");
            if (pumpResponse.IsSuccessStatusCode)
            {
                _pumpState = await pumpResponse.Content.ReadFromJsonAsync<PumpStateUpdate>();
            }
        }
        catch
        {
            // Ignore pump state load errors in UI.
        }

        try
        {
            var alarmsResponse = await Http.GetAsync("/api/alarms/recent?limit=5");
            if (alarmsResponse.IsSuccessStatusCode)
            {
                var alarms = await alarmsResponse.Content.ReadFromJsonAsync<List<SystemAlarmUpdate>>();
                if (alarms is not null)
                {
                    _alarms = alarms
                        .Where(alarm => alarm is not null)
                        .DistinctBy(GetAlarmKey)
                        .Take(5)
                        .ToList();
                }
            }
        }
        catch
        {
            // Ignore alarms load errors in UI.
        }

        try
        {
            var historyResponse = await Http.GetAsync("/api/history/recent?limit=3");
            if (historyResponse.IsSuccessStatusCode)
            {
                var history = await historyResponse.Content.ReadFromJsonAsync<List<RunHistoryEntry>>();
                _recentRuns = history ?? new List<RunHistoryEntry>();
            }
        }
        catch
        {
            // Ignore run history load errors in UI.
        }

        try
        {
            var schedulesResponse = await Http.GetAsync("/api/schedules");
            if (schedulesResponse.IsSuccessStatusCode)
            {
                var schedules = await schedulesResponse.Content.ReadFromJsonAsync<List<Schedule>>();
                if (schedules is not null)
                {
                    (_nextSchedule, _nextScheduleAt) = GetNextSchedule(schedules);
                }
            }
        }
        catch
        {
            // Ignore schedules load errors in UI.
        }
    }

    private static string GetDeviceStatusText(DateTimeOffset? receivedAt)
    {
        if (!receivedAt.HasValue)
        {
            return "unknown";
        }

        return IsFresh(receivedAt) ? "online" : "stale";
    }

    private string GetMqttStatusText()
    {
        if (_health?.Mqtt is null)
        {
            return "unknown";
        }

        return _health.Mqtt.Connected ? "connected" : "disconnected";
    }

    private static bool IsFresh(DateTimeOffset? receivedAt)
    {
        if (!receivedAt.HasValue)
        {
            return false;
        }

        return DateTimeOffset.UtcNow - receivedAt.Value <= DeviceStaleThreshold;
    }

    private static string GetStatusClass(string status)
    {
        return status switch
        {
            "connected" => "status-chip ok",
            "online" => "status-chip ok",
            "stale" => "status-chip warn",
            "disconnected" => "status-chip bad",
            _ => "status-chip unknown"
        };
    }

    private static string GetLastSeenText(DateTimeOffset? when)
    {
        if (!when.HasValue)
        {
            return "never";
        }

        var age = DateTimeOffset.UtcNow - when.Value;
        if (age < TimeSpan.Zero)
        {
            var ahead = age.Negate();
            if (ahead < TimeSpan.FromSeconds(5))
            {
                return "soon";
            }

            if (ahead < TimeSpan.FromMinutes(1))
            {
                return $"in {ahead.Seconds}s";
            }

            if (ahead < TimeSpan.FromHours(1))
            {
                return $"in {ahead.Minutes}m";
            }

            if (ahead < TimeSpan.FromDays(1))
            {
                return $"in {ahead.Hours}h";
            }

            return $"in {ahead.Days}d";
        }
        if (age < TimeSpan.FromSeconds(5))
        {
            return "just now";
        }

        if (age < TimeSpan.FromMinutes(1))
        {
            return $"{age.Seconds}s ago";
        }

        if (age < TimeSpan.FromHours(1))
        {
            return $"{age.Minutes}m ago";
        }

        if (age < TimeSpan.FromDays(1))
        {
            return $"{age.Hours}h ago";
        }

        return $"{age.Days}d ago";
    }

    private bool ContainsAlarm(SystemAlarmUpdate update)
    {
        var key = GetAlarmKey(update);
        return _alarms.Any(alarm => GetAlarmKey(alarm) == key);
    }

    private static string GetAlarmKey(SystemAlarmUpdate update)
    {
        return $"{update.Type}|{update.Severity}|{update.Message}|{update.RaisedAt:O}";
    }

    private static (Schedule? schedule, DateTimeOffset? nextAt) GetNextSchedule(List<Schedule> schedules)
    {
        var nowUtc = DateTimeOffset.UtcNow;
        Schedule? bestSchedule = null;
        DateTimeOffset? bestTime = null;

        foreach (var schedule in schedules)
        {
            if (!schedule.Enabled)
            {
                continue;
            }

            if (!TimeSpan.TryParse(schedule.StartTimeUtc, out var startTime))
            {
                continue;
            }

            var next = GetNextOccurrenceUtc(schedule, startTime, nowUtc);
            if (!next.HasValue)
            {
                continue;
            }

            if (!bestTime.HasValue || next.Value < bestTime.Value)
            {
                bestTime = next;
                bestSchedule = schedule;
            }
        }

        return (bestSchedule, bestTime);
    }

    private static DateTimeOffset? GetNextOccurrenceUtc(Schedule schedule, TimeSpan startTime, DateTimeOffset nowUtc)
    {
        var daySet = ParseDays(schedule.DaysOfWeek);
        for (var i = 0; i < 14; i++)
        {
            var date = nowUtc.UtcDateTime.Date.AddDays(i);
            var day = date.DayOfWeek;
            if (daySet is not null && !daySet.Contains(day))
            {
                continue;
            }

            var dateKey = date.ToString("yyyy-MM-dd");
            if (string.Equals(schedule.LastRunDateUtc, dateKey, StringComparison.Ordinal))
            {
                continue;
            }

            var candidate = new DateTimeOffset(date.Add(startTime), TimeSpan.Zero);
            if (candidate <= nowUtc)
            {
                continue;
            }

            return candidate;
        }

        return null;
    }

    private static HashSet<DayOfWeek>? ParseDays(string? days)
    {
        if (string.IsNullOrWhiteSpace(days))
        {
            return null;
        }

        var set = new HashSet<DayOfWeek>();
        var tokens = days.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var token in tokens)
        {
            if (TryTokenToDay(token, out var day))
            {
                set.Add(day);
            }
        }

        return set.Count == 0 ? null : set;
    }

    private static bool TryTokenToDay(string token, out DayOfWeek day)
    {
        day = token switch
        {
            "Mon" => DayOfWeek.Monday,
            "Tue" => DayOfWeek.Tuesday,
            "Wed" => DayOfWeek.Wednesday,
            "Thu" => DayOfWeek.Thursday,
            "Fri" => DayOfWeek.Friday,
            "Sat" => DayOfWeek.Saturday,
            "Sun" => DayOfWeek.Sunday,
            _ => DayOfWeek.Sunday
        };

        return token is "Mon" or "Tue" or "Wed" or "Thu" or "Fri" or "Sat" or "Sun";
    }

    public async ValueTask DisposeAsync()
    {
        HubClient.WaterLevelUpdated -= HandleWaterLevelUpdated;
        HubClient.PumpStateUpdated -= HandlePumpStateUpdated;
        HubClient.AlarmRaised -= HandleAlarmRaised;
        HubClient.ConnectionStateChanged -= HandleConnectionStateChanged;
        _pollingCts?.Cancel();
    }

    private void StartPolling()
    {
        _pollingCts = new CancellationTokenSource();
        _ = PollLoopAsync(_pollingCts.Token);
    }

    private async Task PollLoopAsync(CancellationToken token)
    {
        var timer = new PeriodicTimer(TimeSpan.FromSeconds(5));
        try
        {
            while (await timer.WaitForNextTickAsync(token))
            {
                await LoadInitialStateAsync();
            }
        }
        catch (OperationCanceledException)
        {
        }
        finally
        {
            timer.Dispose();
        }
    }
}
